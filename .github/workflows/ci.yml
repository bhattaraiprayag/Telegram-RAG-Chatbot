# CI/CD Pipeline for Telegram RAG Chatbot
# Runs on all PRs to main and pushes to main

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.10"

jobs:
  # =============================================================================
  # Disk Space Cleanup (for resource-intensive builds)
  # =============================================================================
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: false
          swap-storage: false

      - name: Log disk space
        run: df -h

  # =============================================================================
  # Linting & Formatting
  # =============================================================================
  lint:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (telegram-bot)
        working-directory: telegram-bot
        run: uv sync --dev

      - name: Run Ruff linter
        working-directory: telegram-bot
        run: uv run ruff check app/ tests/

      - name: Run Ruff formatter check
        working-directory: telegram-bot
        run: uv run ruff format --check app/ tests/

  # =============================================================================
  # Type Checking
  # =============================================================================
  typecheck:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (telegram-bot)
        working-directory: telegram-bot
        run: uv sync --dev

      - name: Run mypy
        working-directory: telegram-bot
        run: uv run mypy app/

  # =============================================================================
  # Unit Tests
  # =============================================================================
  test:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (telegram-bot)
        working-directory: telegram-bot
        run: uv sync --dev

      - name: Run pytest with coverage
        working-directory: telegram-bot
        run: |
          uv run pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: telegram-bot/coverage.xml
          fail_ci_if_error: false

  # =============================================================================
  # Docker Build Verification
  # =============================================================================
  docker-build:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Log disk space
        run: df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build telegram-bot image
        uses: docker/build-push-action@v5
        with:
          context: ./telegram-bot
          file: ./telegram-bot/Dockerfile
          push: false
          tags: telegram-rag-bot:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build ml-api image (CPU test)
        uses: docker/build-push-action@v5
        with:
          context: ./ml-api
          file: ./ml-api/Dockerfile
          push: false
          tags: ml-api-telegram-rag:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =============================================================================
  # Security Scan
  # =============================================================================
  security:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail on vulnerabilities (informational)

  # =============================================================================
  # Pre-commit Hooks
  # =============================================================================
  pre-commit:
    runs-on: ubuntu-latest
    needs: cleanup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install pre-commit
        run: uv tool install pre-commit

      - name: Run pre-commit on all files
        run: uv tool run pre-commit run --all-files --show-diff-on-failure
